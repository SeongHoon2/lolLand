<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.lolland.dao.AuctionDao">

 <!-- AUC_MAIN: RANDOMCODE/A_STATUS 사용 -->
  <select id="selectAucMainByRandomCode" resultType="map">
    SELECT
      SEQ,
      RANDOMCODE,
      A_STATUS,
      TITLE,
      USE_YN,
      REG_DTM,
      UPD_DTM
    FROM lolland.AUC_MAIN
    WHERE RANDOMCODE = #{code}
    LIMIT 1
  </select>

  <!-- 팀장 존재 여부 (LEADERFLG='Y') -->
  <select id="countLeaderByNick" resultType="int">
    SELECT COUNT(1)
    FROM lolland.AUC_MEMBER
    WHERE AUC_SEQ = #{aucSeq}
      AND NICK = #{nick} COLLATE utf8mb4_bin
      AND LEADERFLG = 'Y'
  </select>

  <!-- 팀장 온라인 상태 갱신 -->
  <update id="updateLeaderOnline">
    UPDATE lolland.AUC_MEMBER
    SET ONLINE_YN = #{onlineYn},
        UPD_DTM   = NOW()
    WHERE AUC_SEQ = #{aucSeq}
      AND NICK    = #{nick}
      AND LEADERFLG = 'Y'
  </update>

  <!-- 대기실 스냅샷: 팀장 목록/카운트 -->
  <select id="selectLeaders" resultType="map">
    SELECT
      NICK,
      LEADERFLG,
      READY_YN,
      ONLINE_YN,
      TIER,
      MROLE,
      SROLE,
      NO,
      POINT
    FROM lolland.AUC_MEMBER
    WHERE AUC_SEQ = #{aucSeq}
      AND LEADERFLG = 'Y'
    ORDER BY NO IS NULL, NO ASC, NICK ASC
  </select>

  <!-- READY 토글(팀장만) -->
  <update id="toggleReady">
    UPDATE lolland.AUC_MEMBER
    SET READY_YN = CASE WHEN READY_YN='Y' THEN 'N' ELSE 'Y' END,
        UPD_DTM  = NOW()
    WHERE AUC_SEQ = #{aucSeq}
      AND NICK    =  #{nick}
      AND LEADERFLG = 'Y'
  </update>

  <!-- 활성 경매 수: WAIT/ING 만 카운트 (USE_YN='Y' 권장) -->
  <select id="countActiveAuctions" resultType="int">
    SELECT COUNT(1)
    FROM lolland.AUC_MAIN
    WHERE A_STATUS IN ('WAIT','ING')
      AND USE_YN = 'Y'
  </select>

  <!-- 경매 상태 변경 -->
  <update id="updateAucStatus">
    UPDATE lolland.AUC_MAIN
    SET A_STATUS = #{status},
        UPD_DTM  = NOW()
    WHERE SEQ = #{aucSeq}
  </update>
  
  <update id="markLeaderReady">
  UPDATE lolland.AUC_MEMBER
  SET READY_YN = #{readyYn},
      UPD_DTM  = NOW()
  WHERE AUC_SEQ = #{aucSeq}
    AND NICK    = #{nick}
    AND LEADERFLG = 'Y'
</update>
  
  <update id="setLeaderReady">
  UPDATE lolland.AUC_MEMBER
  SET READY_YN = #{readyYn},
      UPD_DTM  = NOW()
  WHERE AUC_SEQ = #{aucSeq}
    AND NICK    = #{nick}
    AND LEADERFLG = 'Y'
</update>

<!-- 리더가 아닌 선수 목록 (경매 대상) -->
<select id="selectNonLeaderPlayers" resultType="map">
  SELECT
    NO, NICK, TIER, MROLE, SROLE
  FROM lolland.AUC_MEMBER
  WHERE AUC_SEQ = #{aucSeq}
    AND LEADERFLG = 'N'
  ORDER BY COALESCE(NO, 9999), NICK
</select>

<!-- 리더를 AUC_TEAM으로 보충(차등 포인트=POINT, 없으면 1000) -->
<insert id="insertMissingTeamsFromLeaders">
  INSERT INTO lolland.AUC_TEAM (AUC_CD, LEADER_NICK, BUDGET, BUDGET_LEFT)
  SELECT m.AUC_SEQ, m.NICK,
         CASE WHEN COALESCE(m.POINT,0)=0 THEN 1000 ELSE m.POINT END AS BUDGET,
         CASE WHEN COALESCE(m.POINT,0)=0 THEN 1000 ELSE m.POINT END AS BUDGET_LEFT
    FROM lolland.AUC_MEMBER m
    LEFT JOIN lolland.AUC_TEAM t
      ON t.AUC_CD = m.AUC_SEQ AND t.LEADER_NICK = m.NICK
   WHERE m.AUC_SEQ = #{aucSeq}
     AND m.LEADERFLG = 'Y'
     AND t.TEAM_ID IS NULL
</insert>

<!-- 팀 목록 -->
<select id="selectTeamsByAuc" resultType="map">
  SELECT TEAM_ID, LEADER_NICK, BUDGET, BUDGET_LEFT
  FROM lolland.AUC_TEAM
  WHERE AUC_CD = #{aucSeq}
  ORDER BY LEADER_NICK
</select>

<!-- STEP3_INIT 이벤트 (랜덤 순번 저장/재사용) -->
<select id="selectLatestEventByType" resultType="map">
  SELECT EVENT_ID, TYPE, PAYLOAD, TS
  FROM lolland.AUC_EVENT_LOG
  WHERE AUC_CD = #{aucSeq} AND TYPE = #{type}
  ORDER BY EVENT_ID DESC
  LIMIT 1
</select>

<insert id="insertEvent">
  INSERT INTO lolland.AUC_EVENT_LOG (AUC_CD, TYPE, PAYLOAD)
  VALUES (#{aucSeq}, #{type}, CAST(#{payload} AS JSON))
</insert>

<select id="selectLeaderDetails" resultType="map">
  SELECT TEAM_ID, m.NICK, m.TIER, m.MROLE, m.SROLE
  FROM lolland.AUC_MEMBER m
  JOIN lolland.AUC_TEAM t
    ON t.AUC_CD = m.AUC_SEQ AND t.LEADER_NICK = m.NICK
  WHERE m.AUC_SEQ = #{aucSeq}
    AND m.LEADERFLG = 'Y'
</select>

</mapper>