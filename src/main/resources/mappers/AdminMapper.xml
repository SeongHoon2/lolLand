<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.lolland.dao.AdminDao">

<insert id="insertAuctionMain" parameterType="map" useGeneratedKeys="true" keyProperty="SEQ" keyColumn="SEQ">
  INSERT INTO AUC_MAIN (
                         TITLE
                       , RANDOMCODE
                       , A_STATUS
                       , USE_YN
                       , REG_DTM
                       )
                VALUES (
                         #{auctionName}
                       , #{randomCode}
                       , 'SYNC'
                       , 'Y'
                       , NOW()
                       )
</insert>

<insert id="insAuctionMember">
  INSERT INTO AUC_MEMBER (
                           AUC_SEQ
                         , NO
                         , NICK
                         , TIER
                         , MROLE
                         , SROLE
                         , LEADERFLG
                         , POINT
                         , REG_DTM
                         )
                  VALUES (
                           #{AUC_SEQ}
                         , #{NO}
                         , #{NICK}
                         , #{TIER}
                         , #{MROLE}
                         , #{SROLE}
                         , #{LEADERFLG}
                         , #{POINT}
                         , NOW()
                         )
</insert>

<select id="getAucMainList" parameterType="map" resultType="hashmap">
  SELECT
    M.SEQ AS id,
    M.TITLE AS title,
    M.A_STATUS AS status,
    DATE_FORMAT(M.REG_DTM, '%Y-%m-%d %H:%i') AS regDt
  FROM AUC_MAIN M
  WHERE M.USE_YN = 'Y'
    <if test="query != null and query != ''">
      AND M.TITLE LIKE CONCAT('%', #{query}, '%')
    </if>
  ORDER BY M.REG_DTM DESC, M.SEQ DESC
  LIMIT #{offset,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
</select>

<select id="countAucMainList" parameterType="string" resultType="int">
  SELECT COUNT(*)
  FROM AUC_MAIN M
  WHERE M.USE_YN = 'Y'
    <if test="query != null and query != ''">
      AND M.TITLE LIKE CONCAT('%', #{query}, '%')
    </if>
</select>

<select id="getAucMainData" parameterType="long" resultType="hashmap">
  SELECT M.SEQ AS id, M.TITLE AS title, M.A_STATUS AS status,
         DATE_FORMAT(M.REG_DTM,'%Y-%m-%d %H:%i') AS regDt,
         M.RANDOMCODE AS randomCode
  FROM AUC_MAIN M
  WHERE M.SEQ=#{id} AND M.USE_YN='Y'
  LIMIT 1
</select>

<select id="getAuctionMembers" parameterType="map" resultType="hashmap">
  SELECT A.NO AS `order`, A.NICK AS nickname, A.TIER AS tier,
         A.MROLE AS mainPos, A.SROLE AS subPos, A.POINT AS point,
         CASE WHEN A.LEADERFLG='Y' THEN 1 ELSE 0 END AS leader
  FROM AUC_MEMBER A
  WHERE A.AUC_SEQ=#{id}
  ORDER BY A.NO ASC, A.MEM_SEQ ASC
  LIMIT #{offset,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
</select>

<select id="countAuctionMembers" parameterType="long" resultType="int">
  SELECT COUNT(*) FROM AUC_MEMBER WHERE AUC_SEQ=#{id}
</select>

<select id="countActiveAuctions" resultType="int">
  SELECT COUNT(*)
  FROM AUC_MAIN
  WHERE A_STATUS IN ('WAIT','ING')
    AND USE_YN = 'Y'
</select>

<update id="updateStatusIfSyncToWait" parameterType="long">
  UPDATE AUC_MAIN
  SET A_STATUS = 'WAIT',
      UPD_DTM  = NOW()
  WHERE SEQ = #{id}
    AND A_STATUS = 'SYNC'
    AND USE_YN = 'Y'
</update>

<update id="updateStatusToEnd" parameterType="long">
  UPDATE AUC_MAIN
  SET A_STATUS = 'END',
      UPD_DTM  = NOW()
  WHERE SEQ = #{id}
    AND A_STATUS IN ('WAIT','ING')
    AND USE_YN = 'Y'
</update>

<select id="countTeamMembersByTeam" resultType="int">
  SELECT COUNT(*) 
  FROM lolland.AUC_TEAM_MEMBER 
  WHERE TEAM_ID = #{teamId}
</select>

</mapper>
