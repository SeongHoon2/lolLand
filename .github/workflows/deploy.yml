# =========================================================
# ğŸ”§ í¸ì§‘/í™•ì¸ êµ¬ì—­ (ê°’ë§Œ ë°”ê¾¸ë©´ ë©ë‹ˆë‹¤)
# ---------------------------------------------------------
# [GitHub Secrets: ì €ì¥ì†Œ UIì—ì„œ ë“±ë¡]
#   - LS_HOST    : Lightsail ê³µì¸ IP (ì˜ˆ: 52.78.251.164)
#   - LS_USER    : SSH ì‚¬ìš©ì (ì˜ˆ: ec2-user)
#   - LS_SSH_KEY : í”„ë¼ì´ë¹— í‚¤ ì „ì²´(ì¤„ë°”ê¿ˆ í¬í•¨, BEGIN~END í¬í•¨)
#
# [í™˜ê²½ ë³€ìˆ˜: ì„œë²„ íŒŒì¼/ì„œë¹„ìŠ¤ë§Œ ë§ì¶”ë©´ server.xmlì€ ê±´ë“œë¦´ í•„ìš” ì—†ìŒ]
#   - JAVA_VERSION   : 8                  # JDK 1.8.0_202
#   - APP_DIR        : '.'                # pom.xmlì´ ë ˆí¬ ë£¨íŠ¸ë©´ '.', í•˜ìœ„ë©´ í´ë”ëª…
#   - REMOTE_TOMCAT  : /opt/tomcat        # ìë™íƒì§€ ì‹¤íŒ¨ ì‹œ ì“¸ Fallback CATALINA_BASE
#   - TOMCAT_SERVICE : tomcat8            # ì‹¤ì œ ì„œë¹„ìŠ¤ëª…(tomcat ë˜ëŠ” tomcat8)
#   - CONTEXT_NAME   : ROOT               # ë£¨íŠ¸(/)ë¡œ ì“°ë ¤ë©´ 'ROOT'
#   - HEALTH_URL     : http://localhost:8080/   # ì‹¤ì œ ì‚´ì•„ìˆëŠ” ê²½ë¡œë©´ ë” ì¢‹ìŒ(ì˜ˆ: /index.jsp, /health)
#   - REMOTE_TMP     : /tmp/deploy        # ì„ì‹œ ì—…ë¡œë“œ ìœ„ì¹˜
# =========================================================

name: Deploy to Lightsail Tomcat

on:
  push:
    branches: [ main, master ]   # ë‘˜ ì¤‘ ì–´ëŠ ë¸Œëœì¹˜ í‘¸ì‹œì—ë„ ë°°í¬
  workflow_dispatch:              # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

concurrency:
  group: deploy-lightsail
  cancel-in-progress: true

env:
  JAVA_VERSION: '8'
  APP_DIR: '.'
  REMOTE_TOMCAT: '/opt/tomcat'
  TOMCAT_SERVICE: 'tomcat8'
  CONTEXT_NAME: 'ROOT'
  HEALTH_URL: 'http://localhost:8080/'
  REMOTE_TMP: '/tmp/deploy'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify layout
        run: |
          echo "PWD=$PWD"
          ls -la
          test -f "${{ env.APP_DIR }}/pom.xml" || (echo "pom.xml not found in ${{ env.APP_DIR }}" && exit 1)

      - name: Set up Temurin JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
          mvn -v

      - name: Build WAR with Maven
        working-directory: ${{ env.APP_DIR }}
        run: mvn -B -DskipTests package

      # ë©€í‹°ëª¨ë“ˆ/ì„œë¸Œí´ë” ëŒ€ì‘: ë¹Œë“œ ì‚°ì¶œë¬¼(WAR) ìë™ íƒìƒ‰
      - name: Locate WAR
        id: locate-war
        run: |
          set -e
          FOUND=$(find "${{ env.APP_DIR }}" -type f -name "*.war" | head -n 1 || true)
          if [ -z "$FOUND" ]; then
            echo "No WAR found."
            echo "Hints:"
            grep -n "<packaging>" -n "${{ env.APP_DIR }}/pom.xml" || true
            find "${{ env.APP_DIR }}" -maxdepth 3 -type d -name target -print || true
            exit 1
          fi
          echo "WAR_PATH=$FOUND" >> $GITHUB_OUTPUT
          echo "WAR found at: $FOUND"

      - name: Show artifact
        run: ls -l "${{ steps.locate-war.outputs.WAR_PATH }}"

      # SSH ì—°ê²° í™•ì¸(ì„ íƒ)
      - name: Sanity SSH check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          script: 'echo "SSH OK on $(hostname)"; uname -a'

      # ê²½ë¡œ í‰íƒ„í™”: <APP_DIR>/target/xxx.war â†’ /tmp/deploy/xxx.war
      - name: Upload WAR to Lightsail (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          source: "${{ steps.locate-war.outputs.WAR_PATH }}"
          target: ${{ env.REMOTE_TMP }}
          strip_components: 2   # ì¼ë°˜ì ìœ¼ë¡œ "í”„ë¡œì íŠ¸/target" ë‘ ë‹¨ê³„ ì œê±°(í•„ìš”ì‹œ 1~3 ì¡°ì •)

      - name: Verify upload on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          script: |
            echo "List ${{ env.REMOTE_TMP }}:"
            ls -l ${{ env.REMOTE_TMP }} || true
            echo "Find WAR recursively:"
            find ${{ env.REMOTE_TMP }} -maxdepth 3 -type f -name "*.war" -print || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # server.xml í¸ì§‘ ì—†ì´ ë°°í¬: CATALINA_BASE ìë™ íƒì§€ + í—¬ìŠ¤ì²´í¬
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy & Restart Tomcat (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          script: |
            set -euo pipefail

            SERVICE="${{ env.TOMCAT_SERVICE }}"
            FALLBACK_BASE="${{ env.REMOTE_TOMCAT }}"
            TMPDIR="${{ env.REMOTE_TMP }}"
            CONTEXT="${{ env.CONTEXT_NAME }}"
            HEALTH_URL="${{ env.HEALTH_URL }}"

            # 0) CATALINA_BASE ìë™ íƒì§€
            CAT_BASE="$(sudo systemctl show "$SERVICE" -p Environment | sed -n 's/.*CATALINA_BASE=\([^;]*\).*/\1/p' || true)"
            if [ -z "$CAT_BASE" ]; then
              CAT_BASE="$(ps -ef | awk '/org.apache.catalina.startup.Bootstrap/ && !/awk|grep/ { for(i=1;i<=NF;i++) if ($i ~ /-Dcatalina.base=/) { split($i,a,"="); print a[2]; } }' | head -n1 || true)"
            fi
            if [ -z "$CAT_BASE" ]; then
              CAT_BASE="$FALLBACK_BASE"
            fi

            WEBAPPS="$CAT_BASE/webapps"
            WORKDIR="$CAT_BASE/work"

            echo "CATALINA_BASE=$CAT_BASE"
            echo "WEBAPPS=$WEBAPPS"

            sudo mkdir -p "$TMPDIR"
            sudo chown -R "$USER":"$USER" "$TMPDIR"

            # ì—…ë¡œë“œ WAR ì°¾ê¸°(í‰íƒ„í™” ì‹¤íŒ¨ ëŒ€ë¹„ ì¬ê·€)
            WAR_FILE="$(find "$TMPDIR" -maxdepth 3 -type f -name '*.war' | head -n1 || true)"
            if [ -z "$WAR_FILE" ]; then
              echo "WAR not found under $TMPDIR"; exit 1
            fi
            echo "WAR_FILE=$WAR_FILE"

            echo "[1/5] Stop Tomcat"
            sudo systemctl stop "$SERVICE" || true

            echo "[2/5] Clean old app & work"
            sudo rm -rf "$WEBAPPS/${CONTEXT}" "$WORKDIR/"* || true

            echo "[3/5] Deploy new WAR -> $WEBAPPS"
            if [ "$CONTEXT" = "ROOT" ]; then
              sudo rm -f "$WEBAPPS/ROOT.war"
              sudo cp "$WAR_FILE" "$WEBAPPS/ROOT.war"
            else
              sudo rm -f "$WEBAPPS/${CONTEXT}.war"
              sudo cp "$WAR_FILE" "$WEBAPPS/${CONTEXT}.war"
            fi
            sudo ls -l "$WEBAPPS" || true

            echo "[4/5] Start Tomcat"
            sudo systemctl start "$SERVICE"

            echo "[5/5] Health check..."
            # 1ì°¨: ì§€ì • HEALTH_URL
            for i in $(seq 1 40); do   # ìµœëŒ€ 120ì´ˆ ëŒ€ê¸°(3ì´ˆ x 40)
              if curl -fsS "$HEALTH_URL" >/dev/null 2>&1; then
                echo "Health check OK on $HEALTH_URL"; break
              fi
              echo "Retry $i/40 at $HEALTH_URL..."
              sleep 3
            done

            # 2ì°¨: ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ URL ì‹œë„(ì»¨í…ìŠ¤íŠ¸ê°€ ROOTê°€ ì•„ë‹ ë•Œ)
            if ! curl -fsS "$HEALTH_URL" >/dev/null 2>&1; then
              if [ "$CONTEXT" != "ROOT" ]; then
                FALLBACK_URL="http://localhost:8080/${CONTEXT}/"
                echo "Trying fallback URL: $FALLBACK_URL"
                for i in $(seq 1 20); do
                  if curl -fsS "$FALLBACK_URL" >/dev/null 2>&1; then
                    echo "Health check OK on $FALLBACK_URL"; break
                  fi
                  echo "Retry $i/20 at $FALLBACK_URL..."
                  sleep 3
                done
              fi
            fi

            # ìµœì¢… íŒì •
            if ! curl -fsS "$HEALTH_URL" >/dev/null 2>&1; then
              if [ "$CONTEXT" != "ROOT" ]; then
                FALLBACK_URL="http://localhost:8080/${CONTEXT}/"
                if curl -fsS "$FALLBACK_URL" >/dev/null 2>&1; then
                  echo "Deployed successfully (fallback URL OK)."
                  exit 0
                fi
              fi
              echo "Health check failed. Recent logs:"
              sudo journalctl -u "$SERVICE" -n 200 --no-pager || true
              [ -f "$CAT_BASE/logs/catalina.out" ] && sudo tail -n 200 "$CAT_BASE/logs/catalina.out" || true
              exit 1
            fi

            echo "Deployed successfully."

      - name: Show Tomcat status on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          script: |
            sudo systemctl status ${{ env.TOMCAT_SERVICE }} --no-pager || true
            # CATALINA_BASE ë¡œê·¸ë„ ë¤í”„
            CAT_BASE="$(sudo systemctl show ${{ env.TOMCAT_SERVICE }} -p Environment | sed -n 's/.*CATALINA_BASE=\([^;]*\).*/\1/p' || true)"
            [ -z "$CAT_BASE" ] && CAT_BASE="$(ps -ef | awk '/org.apache.catalina.startup.Bootstrap/ && !/awk|grep/ { for(i=1;i<=NF;i++) if ($i ~ /-Dcatalina.base=/) { split($i,a,"="); print a[2]; } }' | head -n1 || true)"
            [ -f "$CAT_BASE/logs/catalina.out" ] && sudo tail -n 200 "$CAT_BASE/logs/catalina.out" || true
