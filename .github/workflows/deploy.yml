name: Deploy to Lightsail Tomcat

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: deploy-lightsail
  cancel-in-progress: true

env:
  # ── 수정 지점 ────────────────────────────────
  JAVA_VERSION: '8'
  APP_DIR: '.'
  REMOTE_TOMCAT: '/opt/tomcat'
  TOMCAT_SERVICE: 'tomcat'               # tomcat 또는 tomcat8
  CONTEXT_NAME: 'ROOT'
  HEALTH_URL: 'http://localhost:8080/'
  REMOTE_TMP: '/tmp/deploy'
  # ────────────────────────────────────────────

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify layout
        run: |
          echo "PWD=$PWD"
          test -f "${{ env.APP_DIR }}/pom.xml" || (echo "pom.xml not found in ${{ env.APP_DIR }}" && exit 1)

      - name: Set up Temurin JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven
          mvn -v

      - name: Build WAR with Maven
        working-directory: ${{ env.APP_DIR }}
        run: mvn -B -DskipTests package

      - name: Locate WAR
        id: locate-war
        run: |
          set -e
          FOUND=$(find "${{ env.APP_DIR }}" -type f -name "*.war" | head -n 1 || true)
          if [ -z "$FOUND" ]; then
            echo "No WAR found."
            grep -n "<packaging>" -n "${{ env.APP_DIR }}/pom.xml" || true
            find "${{ env.APP_DIR }}" -maxdepth 3 -type d -name target -print || true
            exit 1
          fi
          echo "WAR_PATH=$FOUND" >> $GITHUB_OUTPUT
          echo "WAR found at: $FOUND"

      - name: Show artifact
        run: ls -l "${{ steps.locate-war.outputs.WAR_PATH }}"

      - name: Sanity SSH check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          script: 'echo "SSH connected to $(hostname)"; uname -a'

      # ⬇️ 경로 평탄화: lolLand/target/xxx.war → /tmp/deploy/xxx.war
      - name: Upload WAR to Lightsail (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          source: "${{ steps.locate-war.outputs.WAR_PATH }}"
          target: ${{ env.REMOTE_TMP }}
          strip_components: 2   # 'lolLand/target' 두 단계 제거(필요시 1~3로 조정)

      # (선택) 업로드 결과 확인
      - name: Verify upload on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          script: |
            echo "List ${{ env.REMOTE_TMP }}:"
            ls -l ${{ env.REMOTE_TMP }} || true
            echo "Find WAR recursively:"
            find ${{ env.REMOTE_TMP }} -maxdepth 3 -type f -name "*.war" -print || true

      - name: Deploy & Restart Tomcat (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          script: |
            set -euo pipefail

            REMOTE_TOMCAT="${{ env.REMOTE_TOMCAT }}"
            WEBAPPS="$REMOTE_TOMCAT/webapps"
            WORKDIR="$REMOTE_TOMCAT/work"
            TMPDIR="${{ env.REMOTE_TMP }}"
            CONTEXT="${{ env.CONTEXT_NAME }}"
            SERVICE="${{ env.TOMCAT_SERVICE }}"
            HEALTH_URL="${{ env.HEALTH_URL }}"

            sudo mkdir -p "$TMPDIR"
            sudo chown -R "$USER":"$USER" "$TMPDIR"

            # ⬇️ 평탄화 실패 대비: 재귀로 WAR 탐색
            WAR_FILE="$(find "$TMPDIR" -maxdepth 3 -type f -name '*.war' | head -n1 || true)"
            if [ -z "$WAR_FILE" ]; then
              echo "WAR not found under $TMPDIR"; exit 1
            fi
            echo "WAR_FILE=$WAR_FILE"

            echo "[1/4] Stop Tomcat"
            sudo systemctl stop "$SERVICE" || true

            echo "[2/4] Clean old app & work"
            sudo rm -rf "$WEBAPPS/${CONTEXT}" "$WORKDIR/"*

            echo "[3/4] Deploy new WAR"
            if [ "$CONTEXT" = "ROOT" ]; then
              sudo rm -f "$WEBAPPS/ROOT.war"
              sudo cp "$WAR_FILE" "$WEBAPPS/ROOT.war"
            else
              sudo rm -f "$WEBAPPS/${CONTEXT}.war"
              sudo cp "$WAR_FILE" "$WEBAPPS/${CONTEXT}.war"
            fi

            echo "[4/4] Start Tomcat"
            sudo systemctl start "$SERVICE"

            echo "Health check..."
            for i in $(seq 1 30); do
              if curl -fsS "$HEALTH_URL" >/dev/null 2>&1; then
                echo "Health check OK"; break
              fi
              echo "Retry $i/30..."
              sleep 3
            done

            if ! curl -fsS "$HEALTH_URL" >/dev/null 2>&1; then
              echo "Health check failed. Recent logs:"
              sudo journalctl -u "$SERVICE" -n 200 --no-pager || true
              exit 1
            fi

            echo "Deployed successfully."

      - name: Show Tomcat status on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LS_HOST }}
          username: ${{ secrets.LS_USER }}
          key: ${{ secrets.LS_SSH_KEY }}
          script: |
            sudo systemctl status ${{ env.TOMCAT_SERVICE }} --no-pager || true
            sudo journalctl -u ${{ env.TOMCAT_SERVICE }} -n 200 --no-pager || true
