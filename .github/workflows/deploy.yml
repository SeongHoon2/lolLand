name: Deploy to Lightsail Tomcat

on:
  push:
    branches: [ master ] # 필요 시 master로 변경하거나 main, master 둘 다 설정

env:
  JAVA_VERSION: 8
  APP_DIR: lolLand
  REMOTE_TOMCAT: /opt/tomcat
  TOMCAT_SERVICE: tomcat
  CONTEXT_NAME: ROOT
  HEALTH_URL: http://localhost:8080/
  WAR_GLOB: target/*.war
  REMOTE_TMP: /tmp/deploy

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: ${{ env.JAVA_VERSION }}

    # Maven으로 WAR 빌드 (pom.xml 있는 경로 지정)
    - name: Build WAR
      run: |
        cd ${{ env.APP_DIR }}
        mvn -B -DskipTests package

    # WAR 업로드
    - name: Upload WAR to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.LS_HOST }}
        username: ${{ secrets.LS_USER }}
        key: ${{ secrets.LS_SSH_KEY }}
        source: "${{ env.APP_DIR }}/${{ env.WAR_GLOB }}"
        target: ${{ env.REMOTE_TMP }}
        strip_components: 2

    # 배포 및 재시작
    - name: Deploy & Restart Tomcat
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.LS_HOST }}
        username: ${{ secrets.LS_USER }}
        key: ${{ secrets.LS_SSH_KEY }}
        script: |
          set -euo pipefail

          SERVICE="${{ env.TOMCAT_SERVICE }}"
          FALLBACK_BASE="${{ env.REMOTE_TOMCAT }}"
          TMPDIR="${{ env.REMOTE_TMP }}"
          CONTEXT="${{ env.CONTEXT_NAME }}"
          HEALTH_URL="${{ env.HEALTH_URL }}"

          # 정확한 CATALINA_BASE 추출
          CAT_BASE="$(sudo systemctl show "$SERVICE" -p Environment \
            | sed -n 's/^Environment=//p' \
            | tr ' ' '\n' \
            | sed -n 's/^CATALINA_BASE=//p' \
            | sed 's/^"//; s/"$//' \
            | head -n1 || true)"

          if [ -z "$CAT_BASE" ]; then
            CAT_BASE="$(ps -ef \
              | awk '/org.apache.catalina.startup.Bootstrap/ && !/awk|grep/ {
                        for(i=1;i<=NF;i++) if ($i ~ /-Dcatalina.base=/) {
                          split($i,a,"="); sub(/^"/,"",a[2]); sub(/"$/,"",a[2]); print a[2];
                        }
                     }' \
              | head -n1 || true)"
          fi

          if [ -z "$CAT_BASE" ]; then
            CAT_BASE="$FALLBACK_BASE"
          fi

          WEBAPPS="$CAT_BASE/webapps"
          WORKDIR="$CAT_BASE/work"

          echo "CATALINA_BASE=$CAT_BASE"
          echo "WEBAPPS=$WEBAPPS"

          sudo mkdir -p "$TMPDIR"
          sudo chown -R "$USER":"$USER" "$TMPDIR"

          WAR_FILE="$(find "$TMPDIR" -maxdepth 3 -type f -name '*.war' | head -n1 || true)"
          if [ -z "$WAR_FILE" ]; then
            echo "WAR not found under $TMPDIR"; exit 1
          fi
          echo "WAR_FILE=$WAR_FILE"

          echo "[1/5] Stop Tomcat"
          sudo systemctl stop "$SERVICE" || true

          echo "[2/5] Clean old app & work"
          sudo rm -rf "$WEBAPPS/${CONTEXT}" "$WORKDIR/"* || true

          echo "[3/5] Deploy new WAR -> $WEBAPPS"
          if [ "$CONTEXT" = "ROOT" ]; then
            sudo rm -f "$WEBAPPS/ROOT.war"
            sudo cp "$WAR_FILE" "$WEBAPPS/ROOT.war"
          else
            sudo rm -f "$WEBAPPS/${CONTEXT}.war"
            sud
